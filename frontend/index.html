<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>评估结果可视化仪表板</title>
  <!-- 引入 Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- 引入自定义 CSS -->
  <link href="css/style.css" rel="stylesheet">
</head>
<body>
  <div id="app" class="dashboard">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">评估结果可视化仪表板</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" @click="showWeightConfig">
                配置权重
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" @click="showCompareView"
                 v-if="compareItems.length > 0">
                对比 ({{ compareItems.length }})
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" @click="refreshData">刷新数据</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- 加载指示器 -->
      <div v-if="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-2">加载数据中，请稍候...</p>
      </div>

      <div v-else>
        <!-- 统计卡片 -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="stat-card">
              <h5>评估总数</h5>
              <div class="stat-value">{{ stats.count }}</div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="stat-card">
              <h5>总平均分</h5>
              <div class="stat-value">{{ stats.overall_average }}</div>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="stat-card">
              <h5>最高评分维度</h5>
              <div class="stat-value">{{ highestDimension.name }}</div>
              <div>{{ highestDimension.value }}分</div>
            </div>
          </div>
        </div>

        <!-- 图表区域 -->
        <div class="row mb-4">
          <div class="col-md-6 mb-4">
            <div class="chart-container">
              <h3>评分维度分布</h3>
              <canvas id="radarChart"></canvas>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="chart-container">
              <h3>评分维度对比</h3>
              <canvas id="barChart"></canvas>
            </div>
          </div>

          <!-- 时间趋势图 -->
          <div class="col-12 mt-4">
            <div class="chart-container">
              <h3>评分随时间变化趋势</h3>
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <!-- 数据表格 -->
        <div class="data-table">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>评估结果列表</h3>
            <div class="d-flex">
              <input type="text" class="form-control me-2" v-model="searchQuery" placeholder="搜索...">
              <select class="form-select me-2" v-model="sortKey">
                <option value="id">ID</option>
                <option value="timestamp">时间</option>
                <option value="average_score">平均分</option>
                <option value="weighted_average">加权平均分</option>
                <option value="factual_accuracy">事实准确性</option>
                <option value="hallucination_control">幻觉控制</option>
                <option value="professionalism">专业性</option>
              </select>
              <button class="btn btn-outline-secondary me-2" @click="toggleSortOrder">
                {{ sortOrder === 'asc' ? '↑' : '↓' }}
              </button>
              <button class="btn btn-success" @click="exportData">
                导出 CSV
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>时间</th>
                  <th>平均分</th>
                  <th>加权平均分</th>
                  <th>事实准确性</th>
                  <th>幻觉控制</th>
                  <th>专业性</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in filteredAndSortedData" :key="item.id">
                  <td>{{ item.id }}</td>
                  <td>{{ formatDate(item.timestamp) }}</td>
                  <td>{{ item.average_score }}</td>
                  <td><strong>{{ item.weighted_average }}</strong></td>
                  <td>{{ item.factual_accuracy }}</td>
                  <td>{{ item.hallucination_control }}</td>
                  <td>{{ item.professionalism }}</td>
                  <td>
                    <button class="btn btn-sm btn-primary me-1" @click="showDetails(item)">
                      详情
                    </button>
                    <button class="btn btn-sm btn-outline-info" @click="addToCompare(item)">
                      对比
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 无数据提示 -->
          <div v-if="filteredAndSortedData.length === 0" class="text-center my-5">
            <p class="text-muted">暂无评估数据</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 详情模态框 -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">评估详情</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" v-if="selectedItem">
            <div class="row mb-3">
              <div class="col-md-6">
                <p><strong>ID:</strong> {{ selectedItem.id }}</p>
                <p><strong>时间:</strong> {{ formatDate(selectedItem.timestamp) }}</p>
                <p><strong>平均分:</strong> {{ selectedItem.average_score }}</p>
              </div>
              <div class="col-md-6">
                <canvas id="detailRadarChart"></canvas>
              </div>
            </div>

            <div class="mb-3">
              <h6>总结:</h6>
              <div class="summary-text p-2 border rounded">
                {{ selectedItem.summary }}
              </div>
            </div>

            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>评估维度</th>
                  <th>分数</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(value, key) in dimensionScores" :key="key">
                  <td>{{ dimensionLabels[key] || key }}</td>
                  <td>{{ selectedItem[key] }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 对比模态框 -->
    <div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">评估结果对比</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- 选中的项目 -->
            <div class="selected-items mb-4">
              <h6>已选择的评估结果：</h6>
              <div class="d-flex flex-wrap">
                <div v-for="item in compareItems" :key="item.id" class="badge bg-primary me-2 mb-2 p-2">
                  {{ item.id }}
                  <button type="button" class="btn-close btn-close-white ms-2"
                          @click="removeFromCompare(item)" aria-label="Remove"></button>
                </div>
              </div>
            </div>

            <!-- 对比图表 -->
            <div class="chart-container">
              <canvas id="compareChart"></canvas>
            </div>

            <!-- 对比表格 -->
            <div class="table-responsive mt-4">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>评估维度</th>
                    <th v-for="item in compareItems" :key="item.id">{{ item.id }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="dim in Object.keys(dimensionLabels)" :key="dim">
                    <td>{{ dimensionLabels[dim] }}</td>
                    <td v-for="item in compareItems" :key="item.id">
                      {{ item[dim] || '-' }}
                    </td>
                  </tr>
                  <tr>
                    <td><strong>总结</strong></td>
                    <td v-for="item in compareItems" :key="item.id" class="small">
                      {{ item.summary }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 权重配置模态框 -->
    <div class="modal fade" id="weightConfigModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">维度权重配置</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">调整各维度的权重，以便更好地分析评估结果。权重越高，该维度在加权平均分中的影响越大。</p>

            <div class="mb-3" v-for="(weight, dim) in dimensionWeights" :key="dim">
              <label :for="`weight-${dim}`" class="form-label">
                {{ dimensionLabels[dim] || dim }} ({{ weight }})
              </label>
              <input type="range" class="form-range" :id="`weight-${dim}`"
                     min="0" max="5" step="0.5" v-model.number="dimensionWeights[dim]">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="resetWeights">重置</button>
            <button type="button" class="btn btn-primary" @click="applyWeights">应用</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入 JavaScript 库 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 添加调试代码 -->
  <script>
    // 检查 Chart.js 是否正确加载
    window.addEventListener('DOMContentLoaded', (event) => {
      console.log("页面加载完成");
      console.log("Chart 对象是否存在:", typeof Chart !== 'undefined');
      if (typeof Chart !== 'undefined') {
        console.log("Chart.js 版本:", Chart.version);
      }
    });
  </script>

  <!-- 引入自定义 JavaScript -->
  <script src="js/charts.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
